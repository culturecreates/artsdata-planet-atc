name: Fetch and Push ATC entities

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 2 * *'

jobs:

  fetch-atc-entities:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: fetch atc entities
        run: |
          bundle exec ruby src/fetch_atc_entities.rb --token=${{ secrets.API_KEY }}

      - name: upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: json_data
          path: json/

  process-using-ontorefine:
    needs: fetch-atc-entities
    runs-on: ubuntu-latest
    container:
      image: ontotext/refine:1.2.1
      options: --user root
      ports:
        - 7333:7333
    steps:
      - name: download artifact
        uses: actions/download-artifact@v5
        with:
          name: json_data
          path: json/

      - name: Install requirements
        run: apk update && apk add curl && apk add util-linux && apk add jq

      - name: Run ontorefine server
        run: /opt/ontorefine/dist/bin/ontorefine &

      - name: Transform entities with OntoRefine
        shell: bash
        run: |
          mkdir -p outputs
          
          declare -A source_map=(
            ["artist"]="artists"
            ["network"]="networks"
            ["presenter"]="presenters"
            ["performance-space"]="performance-spaces"
            ["representative"]="representatives"
            ["show"]="shows"
            ["tour-booking"]="tour-bookings"
            ["genre"]="genres"
            ["category"]="categories"
          )
          
          for source in "${!source_map[@]}"; do
            file_name=${source_map[$source]}
            
            if [ ! -f "json/${source}.json" ]; then
              echo "Warning: ${source}.json not found, skipping..."
              continue
            fi
            
            echo "Transforming ${file_name} with OntoRefine..."
            
            curl "https://raw.githubusercontent.com/${{github.repository}}/${{github.ref}}/ontorefine/configs/ontorefine-config-${file_name}.json" >> config-${source}.json

            /opt/ontorefine/dist/bin/ontorefine-cli \
            transform json/${source}.json \
            -u http://localhost:7333 \
            --configurations config-${source}.json \
            -f json >> outputs/${file_name}.ttl
            
            echo "âœ“ Completed transformation for ${file_name}"
          done

      - name: Concatenate genres and categories into shows
        run: |
          cat outputs/genres.ttl outputs/categories.ttl >> outputs/shows.ttl
          

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
            name: ttl-file
            path: outputs/

  commit-and-push:
    runs-on: ubuntu-latest
    needs: process-using-ontorefine
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        id: download-step
        uses: actions/download-artifact@v4
        with:
            name: ttl-file
            path: outputs/

      - name: Commit files to GitHub
        run: |
            git pull
            git config --global user.email "actions@github.com"
            git config --global user.name "GitHub Actions"
            git add "outputs/"
            git commit -m "Push Entities from ATC"
            git push

  artsdata-push:
    runs-on: ubuntu-latest
    needs: commit-and-push
    strategy:
      matrix:
        artifact: ["artists", "networks", "presenters", "performance-spaces", "representatives", "shows", "tour-bookings"]
    steps:
      - name: Action setup
        uses: culturecreates/artsdata-pipeline-action@v2
        with:
            artifact: ${{ matrix.artifact }}
            publisher: "${{ secrets.PUBLISHER_URI_GREGORY }}"
            downloadUrl: https://raw.githubusercontent.com/${{github.repository}}/${{github.ref}}/outputs/${{ matrix.artifact }}.ttl

